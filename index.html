<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Installer selector by province</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111827; --card:#ffffff; --border:#e8e8e8; --muted:#666;
    --accent:#0d6efd; --head:#f6f7fb; --answer-bg:#f8fbff; --answer-border:#dfeaff; --preview-bg:#fafafa;
  }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif; margin:24px; background:var(--bg); color:var(--fg); }
  .wrap{ max-width:1100px; margin:0 auto; }
  h1{ font-size:22px; margin-bottom:8px; }
  .hint{ color:var(--muted); font-size:14px; margin-bottom:18px; }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  input[type="text"]{ flex:1 1 520px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--fg); }
  button{ padding:10px 14px; border-radius:10px; border:0; background:var(--accent); color:#fff; cursor:pointer; }
  .grid{ display:grid; grid-template-columns:1fr 420px; gap:18px; align-items:start; }
  .card{ border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); }
  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ padding:10px; border-bottom:1px solid var(--border); text-align:left; color:var(--fg); }
  th{ background:var(--head); }
  .small{ font-size:12px; color:var(--muted); }
  iframe#gmaps{ width:100%; height:420px; border:1px solid var(--border); border-radius:12px; }
  .preview{ white-space:pre-line; border:1px dashed var(--border); border-radius:10px; padding:8px 10px; margin-top:8px; background:var(--preview-bg); }
  .answer{ background:var(--answer-bg); border:1px solid var(--answer-border); color:#173c7a; border-radius:10px; padding:10px 12px; margin-top:10px; }

  /* Dark mode */
  body.dark{
    --bg:#0f172a; --fg:#e5e7eb; --card:#111827; --border:#30374a; --muted:#a1a1aa;
    --accent:#4f46e5; --head:#0b1220; --answer-bg:#0b172a; --answer-border:#1f2a44; --preview-bg:#0b1220;
  }
  body.dark .answer{ color:#cbd5e1; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Installer selector by province</h1>
  <div class="hint">
    Type an <b>address</b>, <b>province</b> or <b>autonomous community</b>. Street abbreviations are normalized
    (<i>cl → Calle, av → Avenida</i>) and the <b>postal code</b> is placed before the locality. Results show
    <b>all installers operating in the selected province</b>, <b>sorted by Rate</b> (highest first).
  </div>

  <div class="row">
    <input id="addr" type="text" placeholder="Examples: 'Valencia' · '46011 Valencia' · 'Comunidad Valenciana' · 'Madrid'"/>
    <button id="go">Search installers</button>
    <button id="darkbtn" title="Toggle dark mode">Dark mode</button>
  </div>

  <div id="formatted" class="preview small"></div>
  <div id="answer" class="answer small" style="display:none;"></div>

  <div class="grid" style="margin-top:16px;">
    <div>
      <div class="card">
        <div class="small">Sorted by <b>Rate</b> (desc). One row per installer (best rate within the province).</div>
        <table id="res">
          <thead><tr><th>Installer</th><th>Province</th><th>Rate</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div><b>Map</b></div>
          <div class="small">Formatted address</div>
        </div>
        <div class="small" style="opacity:.7; margin:-2px 0 10px 0;">created by <b>Luis Daniel Mendoza luisme</b></div>
        <iframe id="gmaps" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:8px;">
    Data source: embedded table (INSTALLER · Address · RATE). Prefer Google Sheets + Maps JS? I can share that variant.
  </div>
</div>

<script>
/* ========== Minimal seed (will be replaced by your TSV) ========== */
const DATA = []; // se rellena desde #tsv-data

/* ========== Address normalizer (ES) ========== */
const STREET_ABBR = [
  { rx:/^(cl|c\/|c\.|cl\.|calle)\b/i, full:"Calle" },
  { rx:/^(av|av\.|avda|avd|avenida)\b/i, full:"Avenida" },
  { rx:/^(ps|pso|p\.º|pº|paseo)\b/i, full:"Paseo" },
  { rx:/^(ctra|crta|carretera)\b/i, full:"Carretera" },
  { rx:/^(pl|pl\.|plaza)\b/i, full:"Plaza" },
  { rx:/^(cam|cno|camino)\b/i, full:"Camino" },
  { rx:/^(rda|ronda|rnd)\b/i, full:"Ronda" },
  { rx:/^(trv|trva|travesi?a)\b/i, full:"Travesía" },
  { rx:/^(pje|ptja|pasaje)\b/i, full:"Pasaje" },
  { rx:/^(urb|urbanizaci[oó]n)\b/i, full:"Urbanización" },
  { rx:/^(pgno|pol[íi]gono|poligono)\b/i, full:"Polígono" }
];
function titleCase(str){ return str.replace(/\S+/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase()); }
function normalizeStreet(raw){
  let s = String(raw||"").trim().replace(/\s+/g, " ");
  const firstLine = s.split(/[\n,]/)[0].trim();
  let out = firstLine;
  for (const rule of STREET_ABBR){ if (rule.rx.test(firstLine)){ out = firstLine.replace(rule.rx, rule.full); break; } }
  out = out.split(" ").map(tok=> (/^\d/.test(tok)? tok : titleCase(tok))).join(" ");
  return out;
}
function extractZip(text){ const m = String(text||"").match(/\b(\d{5})\b/); return m ? m[1] : ""; }
function extractLocality(text){
  const a = String(text||"");
  const cp = extractZip(a);
  if (cp){
    const idx = a.indexOf(cp);
    if (idx>=0){
      const tail = a.slice(idx + cp.length).replace(/[,|\n]/g," ").trim();
      return tail.split(/\s+/).slice(0,3).join(" ").trim();
    }
  }
  const parts = a.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
  return parts.length>1 ? parts[parts.length-1] : "";
}

/* ===== Provinces + Communities ===== */
function norm(s){ return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }

const PROVINCES = [
  {name:"Álava", aliases:["Álava","Araba","Alava"]},
  {name:"Albacete", aliases:["Albacete"]},
  {name:"Alicante", aliases:["Alicante","Alacant"]},
  {name:"Almería", aliases:["Almería","Almeria"]},
  {name:"Ávila", aliases:["Ávila","Avila"]},
  {name:"Badajoz", aliases:["Badajoz"]},
  {name:"Illes Balears", aliases:["Illes Balears","Islas Baleares","Baleares","Mallorca","Menorca","Ibiza"]},
  {name:"Barcelona", aliases:["Barcelona"]},
  {name:"Burgos", aliases:["Burgos"]},
  {name:"Cáceres", aliases:["Cáceres","Caceres"]},
  {name:"Cádiz", aliases:["Cádiz","Cadiz"]},
  {name:"Castellón", aliases:["Castellón","Castello","Castelló"]},
  {name:"Ciudad Real", aliases:["Ciudad Real"]},
  {name:"Córdoba", aliases:["Córdoba","Cordoba"]},
  {name:"A Coruña", aliases:["A Coruña","La Coruña","Coruña","Coruna","A Coruna"]},
  {name:"Cuenca", aliases:["Cuenca"]},
  {name:"Girona", aliases:["Girona","Gerona"]},
  {name:"Granada", aliases:["Granada"]},
  {name:"Guadalajara", aliases:["Guadalajara"]},
  {name:"Gipuzkoa", aliases:["Gipuzkoa","Guipúzcoa","Guipuzcoa"]},
  {name:"Huelva", aliases:["Huelva"]},
  {name:"Huesca", aliases:["Huesca"]},
  {name:"Jaén", aliases:["Jaén","Jaen"]},
  {name:"León", aliases:["León","Leon"]},
  {name:"Lleida", aliases:["Lleida","Lérida","Lerida"]},
  {name:"La Rioja", aliases:["La Rioja","Rioja"]},
  {name:"Lugo", aliases:["Lugo"]},
  {name:"Madrid", aliases:["Madrid"]},
  {name:"Málaga", aliases:["Málaga","Malaga"]},
  {name:"Murcia", aliases:["Murcia"]},
  {name:"Navarra", aliases:["Navarra","Nafarroa"]},
  {name:"Ourense", aliases:["Ourense","Orense"]},
  {name:"Asturias", aliases:["Asturias","Oviedo","Gijón","Gijon","Avilés","Aviles"]},
  {name:"Palencia", aliases:["Palencia"]},
  {name:"Las Palmas", aliases:["Las Palmas"]},
  {name:"Pontevedra", aliases:["Pontevedra"]},
  {name:"Salamanca", aliases:["Salamanca"]},
  {name:"Segovia", aliases:["Segovia"]},
  {name:"Sevilla", aliases:["Sevilla"]},
  {name:"Soria", aliases:["Soria"]},
  {name:"Tarragona", aliases:["Tarragona"]},
  {name:"Santa Cruz de Tenerife", aliases:["Santa Cruz de Tenerife","Tenerife"]},
  {name:"Teruel", aliases:["Teruel"]},
  {name:"Toledo", aliases:["Toledo"]},
  {name:"Valencia", aliases:["Valencia","València"]},
  {name:"Valladolid", aliases:["Valladolid"]},
  {name:"Bizkaia", aliases:["Bizkaia","Vizcaya"]},
  {name:"Zamora", aliases:["Zamora"]},
  {name:"Zaragoza", aliases:["Zaragoza"]},
  {name:"Ceuta", aliases:["Ceuta"]},
  {name:"Melilla", aliases:["Melilla"]},
];

const CP_TO_PROV = {
  "01":"Álava","02":"Albacete","03":"Alicante","04":"Almería","05":"Ávila","06":"Badajoz","07":"Illes Balears","08":"Barcelona","09":"Burgos",
  "10":"Cáceres","11":"Cádiz","12":"Castellón","13":"Ciudad Real","14":"Córdoba","15":"A Coruña","16":"Cuenca","17":"Girona","18":"Granada",
  "19":"Guadalajara","20":"Gipuzkoa","21":"Huelva","22":"Huesca","23":"Jaén","24":"León","25":"Lleida","26":"La Rioja","27":"Lugo","28":"Madrid",
  "29":"Málaga","30":"Murcia","31":"Navarra","32":"Ourense","33":"Asturias","34":"Palencia","35":"Las Palmas","36":"Pontevedra","37":"Salamanca",
  "38":"Santa Cruz de Tenerife","39":"Cantabria","40":"Segovia","41":"Sevilla","42":"Soria","43":"Tarragona","44":"Teruel","45":"Toledo","46":"Valencia",
  "47":"Valladolid","48":"Bizkaia","49":"Zamora","50":"Zaragoza","51":"Ceuta","52":"Melilla"
};

/* Communities → provinces */
const COMMUNITY_TO_PROVINCES = {
  "andalucia": ["Almería","Cádiz","Córdoba","Granada","Huelva","Jaén","Málaga","Sevilla"],
  "aragon": ["Huesca","Teruel","Zaragoza"],
  "asturias": ["Asturias"],
  "baleares": ["Illes Balears"],
  "canarias": ["Las Palmas","Santa Cruz de Tenerife"],
  "cantabria": ["Cantabria"],
  "castilla y leon": ["Ávila","Burgos","León","Palencia","Salamanca","Segovia","Soria","Valladolid","Zamora"],
  "castilla-la mancha": ["Albacete","Ciudad Real","Cuenca","Guadalajara","Toledo"],
  "cataluna": ["Barcelona","Girona","Lleida","Tarragona"],
  "cataluña": ["Barcelona","Girona","Lleida","Tarragona"],
  "catalunya": ["Barcelona","Girona","Lleida","Tarragona"],
  "ceuta": ["Ceuta"],
  "extremadura": ["Badajoz","Cáceres"],
  "galicia": ["A Coruña","Lugo","Ourense","Pontevedra"],
  "la rioja": ["La Rioja"],
  "madrid": ["Madrid"],
  "murcia": ["Murcia"],
  "navarra": ["Navarra"],
  "pais vasco": ["Álava","Gipuzkoa","Bizkaia"],
  "paisvasco": ["Álava","Gipuzkoa","Bizkaia"],
  "euskadi": ["Álava","Gipuzkoa","Bizkaia"],
  "valenciana": ["Alicante","Castellón","Valencia"],
  "comunidad valenciana": ["Alicante","Castellón","Valencia"],
  "comunitat valenciana": ["Alicante","Castellón","Valencia"],
  "melilla": ["Melilla"]
};

function detectProvince(text){
  const s = norm(text);
  for (const p of PROVINCES){ if (p.aliases.some(a => s.includes(norm(a)))) return p.name; }
  const cp = extractZip(text);
  if (cp && CP_TO_PROV[cp.slice(0,2)]) return CP_TO_PROV[cp.slice(0,2)];
  return "";
}
function detectCommunity(text){
  const s = norm(text);
  for (const k in COMMUNITY_TO_PROVINCES){ if (s.includes(k)) return k; }
  if (s.includes("comunidad de madrid")) return "madrid";
  if (s.includes("comunidad valenciana") || s.includes("comunitat valenciana")) return "valenciana";
  return "";
}
function extractProvinceFromAddress(addr){
  const s = String(addr||"");
  // Try by name
  const pByName = detectProvince(s);
  if (pByName) return pByName;
  // Try by postal code
  const cp = extractZip(s);
  if (cp){ const p = CP_TO_PROV[cp.slice(0,2)]; if (p) return p; }
  return "";
}

function provinceAliases(name){
  const n = norm(name);
  const p = PROVINCES.find(p => norm(p.name) === n || p.aliases.some(a => norm(a) === n));
  return p ? p.aliases.map(a => norm(a)).concat([norm(p.name)]) : [n];
}

/* Core: collect ALL installers that have ANY address in the selected province.
   It scans the address text itself (robust), not only a pre-filled field. */
function installersInProvince(rows, provinceName){
  const aliases = new Set(provinceAliases(provinceName)); // e.g., "valencia","valència"
  const agg = new Map(); // key: installer → best rate
  for (const r of rows){
    const addrText = norm(r.Address || r.Zona || "");
    const provField = norm(r.Provincia || "");
    const hitByField = provField && (aliases.has(provField));
    const hitByText  = addrText && [...aliases].some(a => addrText.includes(a));
    if (hitByField || hitByText){
      const k = r.Instalador;
      const rate = Number(r.Calificación ?? r.Rate ?? 0);
      if (!agg.has(k) || rate > Number(agg.get(k).Calificación)) {
        agg.set(k, { Instalador:k, Provincia:provinceName, Calificación:rate });
      }
    }
  }
  return Array.from(agg.values()).sort((a,b)=> b.Calificación - a.Calificación || a.Instalador.localeCompare(b.Instalador));
}

function installersInCommunity(rows, communityKey){
  const provs = COMMUNITY_TO_PROVINCES[communityKey] || [];
  const agg = new Map();
  for (const p of provs){
    for (const row of installersInProvince(rows, p)){
      const k=row.Instalador, rt=row.Calificación;
      if (!agg.has(k) || rt > agg.get(k).Calificación) agg.set(k, row);
    }
  }
  return Array.from(agg.values()).sort((a,b)=> b.Calificación - a.Calificación || a.Instalador.localeCompare(b.Instalador));
}

function toNum(x){ const n = parseFloat(String(x).replace(",", ".")); return isNaN(n) ? 0 : n; }
function activeOnly(rows){ return rows.filter(r => String(r.Activo||"Sí").toLowerCase().match(/^(si|sí|true|yes)$/)); }

function renderTable(rows){
  const tb = document.querySelector("#res tbody");
  tb.innerHTML = "";
  if(!rows.length){
    const tr=document.createElement("tr");
    const td=document.createElement("td");
    td.colSpan=3;
    td.textContent="No matches. Type a province (e.g., Valencia, Alicante, Madrid) or a community (Andalucía, Galicia…).";
    tr.appendChild(td); tb.appendChild(tr); return;
  }
  for(const r of rows){
    const tr=document.createElement("tr");
    const td1=document.createElement("td"); td1.textContent=r.Instalador;
    const td2=document.createElement("td"); td2.textContent=r.Provincia || "(unknown)";
    const td3=document.createElement("td"); td3.textContent=(r.Calificación ?? 0);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tb.appendChild(tr);
  }
}

/* Search, explanation & map */
function buildFormattedAddress(raw){
  const street = normalizeStreet(raw);
  const cp = extractZip(raw);
  const loc = extractLocality(raw);
  let line1 = street || "";
  let line2 = (cp ? cp+" " : "") + (loc || "");
  line2 = line2.trim();
  const formatted = [line1, line2].filter(Boolean).join("\n");
  return { formatted, line1, line2, cp, loc };
}
function updateMapFromFormatted(formatted){
  const iframe = document.getElementById("gmaps");
  const q = encodeURIComponent(String(formatted||"").replace(/\n/g, ", "));
  iframe.src = `https://www.google.com/maps?q=${q}&output=embed`;
}
function buildAnswerText(addrRaw, formatted, province, community, rows){
  const box = document.getElementById("answer");
  const names = rows.map(r=>r.Instalador);
  let msg = "";
  if (!addrRaw.trim()){
    msg = "No address provided. Showing active installers in general (type a province or community to filter).";
  } else if (province && rows.length){
    msg = `Interpreted address:\n${formatted}\n\nDetected province: ${province}.\n\nInstallers operating in this province (sorted by rate): ${names.join(", ")}.`;
  } else if (community && rows.length){
    msg = `Interpreted address:\n${formatted}\n\nDetected autonomous community: ${community}.\n\nInstallers operating in its provinces (sorted by rate): ${names.join(", ")}.`;
  } else if (province || community){
    msg = `Interpreted address:\n${formatted}\n\nDetected ${province ? "province" : "community"}: ${province || community}.\n\nNo active installers found in the embedded table for that area.`;
  } else {
    msg = `Interpreted address:\n${formatted}\n\nCouldn't detect a province/community. Try “Valencia”, “Alicante”, “Madrid”… or add a postal code.`;
  }
  box.textContent = msg;
  box.style.display = "block";
}

/* Main search */
function search(){
  const raw = document.getElementById("addr").value || "";
  const { formatted, line2 } = buildFormattedAddress(raw);
  document.getElementById("formatted").textContent = formatted || "—";

  const province = detectProvince(line2 || raw);
  const communityKey = detectCommunity(line2 || raw);

  const base = activeOnly(DATA);
  let ordered = [];

  if (province){
    ordered = installersInProvince(base, province);
  } else if (communityKey){
    ordered = installersInCommunity(base, communityKey);
  } else {
    // No scope detected: show overall best per installer (any province)
    const best = new Map();
    for (const r of base){
      const k = r.Instalador, rt = toNum(r.Calificación ?? r.Rate ?? 0);
      if (!best.has(k) || rt > toNum(best.get(k).Calificación)){
        best.set(k, { Instalador:k, Provincia:r.Provincia || "(unknown)", Calificación:rt });
      }
    }
    ordered = Array.from(best.values()).sort((a,b)=> b.Calificación - a.Calificación || a.Instalador.localeCompare(b.Instalador));
  }

  renderTable(ordered);
  buildAnswerText(raw, formatted || raw, province, communityKey, ordered);
  updateMapFromFormatted(formatted || raw || "Spain");
}

/* Events */
document.getElementById("go").addEventListener("click", search);
/* Enter to search */
document.getElementById("addr").addEventListener("keydown", (ev)=>{ if (ev.key === "Enter"){ ev.preventDefault(); search(); }});

/* Dark mode */
function applyDark(on){
  document.body.classList.toggle("dark", !!on);
  localStorage.setItem("dark", on ? "1" : "0");
  document.getElementById("darkbtn").textContent = on ? "Light mode" : "Dark mode";
}
document.getElementById("darkbtn").addEventListener("click", ()=> applyDark(!document.body.classList.contains("dark")));
applyDark(localStorage.getItem("dark")==="1");

/* Initial state */
document.getElementById("formatted").textContent = "—";
document.getElementById("answer").style.display = "none";
updateMapFromFormatted("Spain");
</script>

<!-- ======= PASTE HERE YOUR FULL TABLE (TSV with headers: INSTALLER \t Address \t RATE) ======= -->
<script type="text/plain" id="tsv-data">
<!-- Replace this comment with your FULL table:
INSTALLER<TAB>Address<TAB>RATE
(then all rows you pasted: BAINGA<TAB>C. Luxemburgo, 28, 03130 Alicante...<TAB>5
...) -->
</script>

<!-- ===== TSV parser → loads your table into DATA ===== -->
<script>
(function(){
  const tsvEl = document.getElementById('tsv-data');
  if (!tsvEl) return;
  const raw = (tsvEl.textContent || tsvEl.innerText || "").trim();
  if (!raw) return;

  const hasTab = raw.includes('\t');
  const lines = raw.split(/\r?\n/).filter(l => l.trim().length);
  if (!lines.length) return;

  // Headers
  const header = lines.shift();
  const headers = hasTab ? header.split('\t') : header.trim().split(/\s{2,}/);
  const iInst = headers.findIndex(h => /^installer/i.test(h));
  const iAddr = headers.findIndex(h => /^address/i.test(h));
  const iRate = headers.findIndex(h => /^rate/i.test(h));

  // Parse rows
  const out = [];
  for (const line of lines){
    let cols = hasTab ? line.split('\t') : line.trim().split(/\s{2,}/);
    if (!cols.length) continue;

    // Heuristic if last token is a number (RATE)
    if ((hasTab && cols.length < 3) || (!hasTab && cols.length < 3)){
      const m = line.match(/(.*)\s+(\d+(?:[.,]\d+)?)\s*$/);
      if (m){
        const left = m[1].trim();
        const rateStr = m[2];
        if (hasTab && left.includes('\t')) cols = left.split('\t').concat([rateStr]);
        else {
          const mm = left.match(/^(.+?)\s{2,}(.+)$/);
          if (mm) cols = [mm[1], mm[2], rateStr];
        }
      }
    }

    const inst = (cols[iInst >= 0 ? iInst : 0]||"").trim();
    const addr = (cols[iAddr >= 0 ? iAddr : 1]||"").trim();
    const rate = parseFloat(String(cols[iRate >= 0 ? iRate : cols.length-1]||"0").replace(",", "."));

    if (inst && addr){
      out.push({
        Instalador: inst,
        Address: addr,
        Zona: addr,
        Activo: "Sí",
        Calificación: isNaN(rate) ? 0 : rate,
        Provincia: extractProvinceFromAddress(addr)
      });
    }
  }

  if (out.length){
    DATA.length = 0;
    for (const r of out) DATA.push(r);
    // Default render: if an input exists, search; else show the most common province
    const current = document.getElementById("addr").value.trim();
    if (current){ search(); } else {
      const freq = {};
      for (const r of DATA){ const p=r.Provincia||""; if(p) freq[p]=(freq[p]||0)+1; }
      const topProv = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0]?.[0] || "Valencia";
      renderTable(installersInProvince(DATA, topProv));
    }
  }
})();
</script>
</body>
</html>
