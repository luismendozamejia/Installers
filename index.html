<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Selector de instaladores por direcci√≥n</title>
<style>
  /* ====== Tema (claro/oscuro) con variables ====== */
  :root{
    --bg:#ffffff;
    --text:#111;
    --border:#e8e8e8;
    --muted:#666;
    --accent:#0d6efd;
    --card:#ffffff;
    --table-head:#f6f7fb;
    --preview:#fafafa;
    --answer-bg:#f8fbff;
    --answer-border:#dfeaff;
    --iframe-border:var(--border);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0f1216;
      --text:#e8e8e8;
      --border:#262b32;
      --muted:#a2a7af;
      --accent:#5aa2ff;
      --card:#151a20;
      --table-head:#1b2128;
      --preview:#151a20;
      --answer-bg:#121925;
      --answer-border:#24324a;
      --iframe-border:var(--border);
    }
  }
  [data-theme="dark"]{
    --bg:#0f1216;
    --text:#e8e8e8;
    --border:#262b32;
    --muted:#a2a7af;
    --accent:#5aa2ff;
    --card:#151a20;
    --table-head:#1b2128;
    --preview:#151a20;
    --answer-bg:#121925;
    --answer-border:#24324a;
    --iframe-border:var(--border);
  }

  /* ====== Estilos base ====== */
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
    margin: 24px;
    background: var(--bg);
    color: var(--text);
    transition: background .2s ease, color .2s ease, border-color .2s ease;
  }
  .wrap { max-width: 1100px; margin: 0 auto; }
  h1 { font-size: 22px; margin-bottom: 8px; }
  .hint { color: var(--muted); font-size: 14px; margin-bottom: 18px; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  input[type="text"] {
    flex: 1 1 520px; padding: 10px 12px; border-radius: 10px;
    border: 1px solid var(--border); background: var(--bg); color: var(--text);
    outline: none;
  }
  input[type="text"]::placeholder{ color: var(--muted); }
  button {
    padding: 10px 14px; border-radius: 10px; border: 0;
    background: var(--accent); color:white; cursor:pointer;
  }
  .ghost {
    background: transparent; color: var(--text); border:1px solid var(--border);
  }
  .grid { display:grid; grid-template-columns: 1fr 420px; gap: 18px; align-items:start; }
  .card { border:1px solid var(--border); border-radius: 14px; padding: 14px; background:var(--card); }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
  th { background: var(--table-head); border-top-left-radius: 10px; border-top-right-radius: 10px; }
  .small { font-size:12px; color:var(--muted); }
  iframe#gmaps { width:100%; height:420px; border:1px solid var(--iframe-border); border-radius:12px; background:#0000; }
  .preview {
    white-space:pre-line; border:1px dashed var(--border); border-radius:10px;
    padding:8px 10px; margin-top:8px; background:var(--preview); color: var(--text);
  }
  .answer {
    background:var(--answer-bg); border:1px solid var(--answer-border);
    color:#cfe1ff; /* mantiene contraste en dark; el texto real lo ponemos inline para consistencia */
    border-radius:10px; padding:10px 12px; margin-top:10px;
  }
  .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .left, .right { display:flex; gap:8px; align-items:center; }
  .footer { margin-top:16px; color:var(--muted); font-size:12px; text-align:center; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; border:1px solid var(--border); border-radius:6px; padding:1px 6px; color:var(--text); }
  @media (max-width: 900px){
    .grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1>Selector de instaladores por direcci√≥n</h1>
    <div class="right">
      <button id="themeToggle" class="ghost" aria-label="Alternar modo nocturno" title="Alternar modo nocturno">üåô Modo nocturno</button>
    </div>
  </div>

  <div class="hint">
    Escribe una <b>direcci√≥n</b> (o ciudad/provincia). Normalizamos abreviaturas (<i>cl ‚Üí Calle, av ‚Üí Avenida</i>) y
    colocamos el <b>c√≥digo postal</b> antes de la localidad. Ver√°s instaladores <b>activos</b> ordenados por <b>Calificaci√≥n</b>.
  </div>

  <div class="row">
    <input id="addr" type="text" placeholder="Ej.: cl luis suarez 28, 33010 oviedo (pulsa Enter)" aria-label="Direcci√≥n para buscar instaladores" />
    <button id="go">Buscar instaladores</button>
  </div>
  <div class="small" style="margin-top:-4px;">Sugerencia: pulsa <span class="kbd">Enter</span> para iniciar la b√∫squeda.</div>

  <div id="formatted" class="preview small"></div>
  <div id="answer" class="answer small" style="display:none; color: #173c7a;"></div>

  <div class="grid" style="margin-top:16px;">
    <div>
      <div class="card">
        <div class="small">Resultado ordenado por <b>Calificaci√≥n</b> (desc). Solo instaladores <b>Activos</b>.</div>
        <table id="res">
          <thead><tr><th>Instalador</th><th>Zona</th><th>Calificaci√≥n</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div><b>Mapa</b></div>
          <div class="small">Se muestra la direcci√≥n formateada</div>
        </div>
        <iframe id="gmaps" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Mapa de la direcci√≥n"></iframe>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:8px;">
    Fuente: tabla embebida. ¬øLo quieres con Google Sheets + Maps JS (marcador preciso)? Puedo pasarte esa variante.
  </div>

  <div class="footer">
    created by <b>Luis Daniel Mendoza Mejia</b> <span class="small">@luisme</span>
  </div>
</div>

<script>
/* ================== DATOS (edita si necesitas) ================== */
const DATA = [
  { Instalador:"Solsystem", Zona:"Barcelona (incidencias) y resto de Catalu√±a (seg√∫n caso)", Activo:"No (pausado)", Calificaci√≥n:3 },
  { Instalador:"Sunsolutions (Mar√≠a)", Zona:"Barcelona", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"Harrak", Zona:"Barcelona", Activo:"S√≠", Calificaci√≥n:3 },
  { Instalador:"Sergio (ACP / ACP Plus)", Zona:"Gij√≥n + ~250 km alrededor", Activo:"S√≠", Calificaci√≥n:5 },
  { Instalador:"Kaylon", Zona:"Madrid y alrededores", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"Soleon", Zona:"Madrid (entre Murcia y Madrid)", Activo:"S√≠", Calificaci√≥n:1 },
  { Instalador:"Inergya", Zona:"Madrid y alrededores", Activo:"S√≠", Calificaci√≥n:3 },
  { Instalador:"Vettes", Zona:"Madrid y alrededores", Activo:"S√≠", Calificaci√≥n:5 },
  { Instalador:"Jos√© Manuel Bugidos", Zona:"Madrid", Activo:"S√≠", Calificaci√≥n:3 },
  { Instalador:"Insvert (Javier)", Zona:"Alicante y Valencia", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"Alrola", Zona:"Valencia", Activo:"S√≠", Calificaci√≥n:2 },
  { Instalador:"Bainga", Zona:"Valencia", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"LEUK", Zona:"Sevilla (Andaluc√≠a)", Activo:"S√≠", Calificaci√≥n:0 },
  { Instalador:"Teleplaca", Zona:"Sevilla (Andaluc√≠a)", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"ERA Renovables", Zona:"Sevilla (Andaluc√≠a)", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"Vector Solar", Zona:"Granada", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"Jovitel", Zona:"Almer√≠a y M√°laga", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"BSS", Zona:"Madrid", Activo:"S√≠", Calificaci√≥n:2 },
  { Instalador:"Fuerza y Honor (F&H)", Zona:"Islas Baleares", Activo:"S√≠", Calificaci√≥n:3 },
  { Instalador:"Soluciones Solares Ib√©ricas", Zona:"Islas Baleares", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"Ecoamper", Zona:"(zona no indicada)", Activo:"S√≠", Calificaci√≥n:5 },
  { Instalador:"Ecosar", Zona:"(zona no indicada)", Activo:"S√≠", Calificaci√≥n:4 },
  { Instalador:"EEGA", Zona:"(zona no indicada)", Activo:"S√≠", Calificaci√≥n:2 },
];

/* ========== Normalizador de direcci√≥n (ES) ========== */
const STREET_ABBR = [
  { rx:/^(cl|c\/|c\.|cl\.|calle)\b/i, full:"Calle" },
  { rx:/^(av|av\.|avda|avd|avenida)\b/i, full:"Avenida" },
  { rx:/^(ps|pso|p\.¬∫|p¬∫|paseo)\b/i, full:"Paseo" },
  { rx:/^(ctra|crta|carretera)\b/i, full:"Carretera" },
  { rx:/^(pl|pl\.|plaza)\b/i, full:"Plaza" },
  { rx:/^(cam|cno|camino)\b/i, full:"Camino" },
  { rx:/^(rda|ronda|rnd)\b/i, full:"Ronda" },
  { rx:/^(trv|trva|travesi?a)\b/i, full:"Traves√≠a" },
  { rx:/^(pje|ptja|pasaje)\b/i, full:"Pasaje" },
  { rx:/^(urb|urbanizaci[o√≥]n)\b/i, full:"Urbanizaci√≥n" },
  { rx:/^(pgno|pol[√≠i]gono|poligono)\b/i, full:"Pol√≠gono" }
];

function titleCase(str){
  return str.replace(/\S+/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase());
}

function normalizeStreet(raw){
  let s = String(raw||"").trim().replace(/\s+/g, " ");
  const firstLine = s.split(/[\n,]/)[0].trim();
  let out = firstLine;
  for (const rule of STREET_ABBR){
    if (rule.rx.test(firstLine)){
      out = firstLine.replace(rule.rx, rule.full);
      break;
    }
  }
  out = out.split(" ").map(tok=> (/^\d/.test(tok)? tok : titleCase(tok))).join(" ");
  return out;
}

function extractZip(text){
  const m = String(text||"").match(/\b(\d{5})\b/);
  return m ? m[1] : "";
}

function extractLocality(text){
  const a = String(text||"");
  const cp = extractZip(a);
  if (cp){
    const idx = a.indexOf(cp);
    if (idx>=0){
      const tail = a.slice(idx + cp.length).replace(/[,|\n]/g," ").trim();
      return tail.split(/\s+/).slice(0,3).join(" ").trim();
    }
  }
  const parts = a.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
  return parts.length>1 ? parts[parts.length-1] : "";
}

/* ====== Palabras clave por regi√≥n para cruzar con "Zona" ====== */
const REGION_KEYWORDS = {
  "madrid": ["madrid","boadilla","villaviciosa","alcobendas","alcorc√≥n","alcorcon","getafe","m√≥stoles","mostoles","pozuelo"],
  "barcelona": ["barcelona","sant boi","sant cugat","badalona","hospitalet","l'hospitalet"],
  "valencia": ["valencia","val√®ncia","sagunto","torrent"],
  "alicante": ["alicante","alacant","elche","elx","benidorm"],
  "sevilla": ["sevilla","dos hermanas","camas","alcal√° de guada√≠ra","alcala de guadaira"],
  "granada": ["granada","motril","armilla"],
  "malaga": ["m√°laga","malaga","marbella","fuengirola","v√©lez-m√°laga","velez malaga"],
  "almeria": ["almer√≠a","almeria","roquetas","el ejido"],
  "asturias": ["asturias","gij√≥n","gijon","oviedo","aviles","avil√©s","norte","castilla y le√≥n","galicia"],
  "baleares": ["baleares","mallorca","menorca","ibiza","illes balears","islas baleares","palma"],
  "murcia": ["murcia","cartagena"]
};

function detectRegionsByText(text){
  const a = String(text||"").toLowerCase();
  const hits = new Set();
  for(const tag in REGION_KEYWORDS){
    if(REGION_KEYWORDS[tag].some(k=> a.includes(k))) hits.add(tag);
  }
  return Array.from(hits);
}

/* ================== Recomendador ================== */
function toNum(x){ const n = parseFloat(String(x).replace(",", ".")); return isNaN(n) ? 0 : n; }
function activeOnly(rows){ return rows.filter(r => String(r.Activo||"").toLowerCase().match(/^(si|s√≠|true|yes)$/)); }

function matchInstallersByRegions(rows, regions){
  if(!regions.length) return rows;
  const words = [];
  for(const r of regions){
    if(r==="asturias") words.push("asturias","gij√≥n","gijon","norte","castilla y le√≥n","galicia");
    else if(r==="baleares") words.push("baleares","mallorca","ibiza","menorca","illes balears","islas baleares","palma");
    else words.push(r);
  }
  let cands = rows.filter(r => words.some(w => String(r.Zona||"").toLowerCase().includes(w)));
  if(!cands.length){
    cands = rows.filter(r => String(r.Zona||"").toLowerCase().includes("alrededor"));
  }
  return cands;
}

function sortByRating(rows){
  return rows.slice().sort((a,b)=>{
    const d = toNum(b.Calificaci√≥n) - toNum(a.Calificaci√≥n);
    if (Math.abs(d) > 1e-9) return d;
    return String(a.Instalador).localeCompare(String(b.Instalador));
  });
}

function renderTable(rows){
  const tb = document.querySelector("#res tbody");
  tb.innerHTML = "";
  if(!rows.length){
    const tr=document.createElement("tr");
    const td=document.createElement("td");
    td.colSpan=3; td.textContent="Sin coincidencias. Prueba con ciudad/provincia (p.ej. Madrid, Valencia, Sevilla, Mallorca).";
    tr.appendChild(td); tb.appendChild(tr);
    return;
  }
  for(const r of rows){
    const tr=document.createElement("tr");
    const td1=document.createElement("td"); td1.textContent=r.Instalador;
    const td2=document.createElement("td"); td2.textContent=r.Zona;
    const td3=document.createElement("td"); td3.textContent=(r.Calificaci√≥n ?? 0);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tb.appendChild(tr);
  }
}

/* ================== B√∫squeda, Explicaci√≥n & Mapa ================== */
function buildFormattedAddress(raw){
  const street = normalizeStreet(raw);
  const cp = extractZip(raw);
  const loc = extractLocality(raw);

  let line1 = street || "";
  let line2 = (cp ? cp+" " : "") + (loc || "");
  line2 = line2.trim();

  const formatted = [line1, line2].filter(Boolean).join("\n");
  return { formatted, line1, line2, cp, loc };
}

function updateMapFromFormatted(formatted){
  const iframe = document.getElementById("gmaps");
  const q = encodeURIComponent(formatted.replace(/\n/g, ", "));
  iframe.src = `https://www.google.com/maps?q=${q}&output=embed`;
}

function buildAnswerText(addrRaw, formatted, regions, ordered){
  const box = document.getElementById("answer");
  const names = ordered.map(r=>r.Instalador).slice(0,8); // hasta 8 para no saturar
  const regionTxt = regions.length ? regions.join(", ") : "‚Äî";

  let msg = "";
  if (!addrRaw.trim()){
    msg = "No se ha indicado direcci√≥n. Te muestro los instaladores activos en general, ordenados por calificaci√≥n.";
  } else if (!regions.length && ordered.length){
    msg = `Direcci√≥n interpretada como:\n${formatted}\n\nNo detect√© una regi√≥n espec√≠fica en el texto, as√≠ que te muestro instaladores activos ordenados por calificaci√≥n.`;
  } else if (regions.length && ordered.length){
    msg = `Direcci√≥n interpretada como:\n${formatted}\n\nRegi√≥n detectada: ${regionTxt}.\n\nInstaladores que act√∫an en la zona (ordenados por calificaci√≥n): ${names.join(", ")}.`;
  } else if (regions.length && !ordered.length){
    msg = `Direcci√≥n interpretada como:\n${formatted}\n\nRegi√≥n detectada: ${regionTxt}.\n\nNo encontr√© instaladores activos que coincidan exactamente con esa zona. Prueba con la ciudad/provincia o revisa abreviaturas.`;
  } else {
    msg = `Direcci√≥n interpretada como:\n${formatted}\n\nNo encontr√© coincidencias. Prueba indicando la ciudad/provincia (p. ej., ‚Äú33010 Oviedo‚Äù o ‚ÄúMadrid‚Äù).`;
  }

  box.textContent = msg;
  box.style.display = "block";
  // Ajuste de color del texto para ambos temas
  box.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text');
}

function search(){
  const raw = document.getElementById("addr").value || "";
  const { formatted, line2 } = buildFormattedAddress(raw);
  document.getElementById("formatted").textContent = formatted || "‚Äî";

  // Regi√≥n por CP/localidad (l√≠nea 2) o por el texto completo
  const regions = detectRegionsByText(line2 || raw);
  const matches = matchInstallersByRegions(activeOnly(DATA), regions);
  const ordered = sortByRating(matches);
  renderTable(ordered);

  // Respuesta textual explicativa
  buildAnswerText(raw, formatted || raw, regions, ordered);

  // Mapa
  updateMapFromFormatted(formatted || raw || "Espa√±a");
}

/* ================== UI: Enter para buscar & Tema ================== */
const goBtn = document.getElementById("go");
goBtn.addEventListener("click", search);

const addrInput = document.getElementById("addr");
addrInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    search();
  }
});

const themeToggle = document.getElementById("themeToggle");
const root = document.documentElement;

function applyTheme(theme){
  if(theme === "dark"){
    root.setAttribute("data-theme","dark");
    themeToggle.textContent = "‚òÄÔ∏è Modo claro";
    themeToggle.setAttribute("aria-label","Alternar a modo claro");
    themeToggle.title = "Alternar a modo claro";
  } else {
    root.removeAttribute("data-theme");
    themeToggle.textContent = "üåô Modo nocturno";
    themeToggle.setAttribute("aria-label","Alternar a modo nocturno");
    themeToggle.title = "Alternar a modo nocturno";
  }
}

function getSystemPrefersDark(){
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

function initTheme(){
  const saved = localStorage.getItem("theme-pref");
  const theme = saved || (getSystemPrefersDark() ? "dark" : "light");
  applyTheme(theme);
}
themeToggle.addEventListener("click", ()=>{
  const isDark = root.getAttribute("data-theme")==="dark";
  const next = isDark ? "light" : "dark";
  applyTheme(next);
  localStorage.setItem("theme-pref", next);
});
initTheme();

/* ================== Primer render (vac√≠o) ================== */
document.getElementById("formatted").textContent = "‚Äî";
document.getElementById("answer").style.display = "none";
renderTable(sortByRating(activeOnly(DATA)));
updateMapFromFormatted("Espa√±a");
</script>
</body>
</html>
