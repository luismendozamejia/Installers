<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Installer selector by province</title>
<style>
  :root{
    --bg:#ffffff;
    --fg:#111827;
    --card:#ffffff;
    --border:#e8e8e8;
    --muted:#666;
    --accent:#0d6efd;
    --head:#f6f7fb;
    --answer-bg:#f8fbff;
    --answer-border:#dfeaff;
    --preview-bg:#fafafa;
  }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif; margin:24px; background:var(--bg); color:var(--fg); }
  .wrap { max-width:1100px; margin:0 auto; }
  h1 { font-size:22px; margin-bottom:8px; }
  .hint { color:var(--muted); font-size:14px; margin-bottom:18px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  input[type="text"]{ flex:1 1 520px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--fg); }
  button{ padding:10px 14px; border-radius:10px; border:0; background:var(--accent); color:#fff; cursor:pointer; }
  .grid{ display:grid; grid-template-columns:1fr 420px; gap:18px; align-items:start; }
  .card{ border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); }
  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ padding:10px; border-bottom:1px solid var(--border); text-align:left; color:var(--fg); }
  th{ background:var(--head); }
  .small{ font-size:12px; color:var(--muted); }
  iframe#gmaps{ width:100%; height:420px; border:1px solid var(--border); border-radius:12px; }
  .preview{ white-space:pre-line; border:1px dashed var(--border); border-radius:10px; padding:8px 10px; margin-top:8px; background:var(--preview-bg); }
  .answer{ background:var(--answer-bg); border:1px solid var(--answer-border); color:#173c7a; border-radius:10px; padding:10px 12px; margin-top:10px; }

  /* Dark mode */
  body.dark{
    --bg:#0f172a; --fg:#e5e7eb; --card:#111827; --border:#30374a; --muted:#a1a1aa;
    --accent:#4f46e5; --head:#0b1220; --answer-bg:#0b172a; --answer-border:#1f2a44; --preview-bg:#0b1220;
  }
  body.dark .answer{ color:#cbd5e1; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Installer selector by province</h1>
  <div class="hint">
    Type an <b>address</b>, <b>province</b> or <b>autonomous community</b>. We normalize street abbreviations
    (<i>cl → Calle, av → Avenida</i>) and put the <b>postal code</b> before the locality. You’ll see <b>active</b> installers,
    <b>sorted by Rating</b>, that have at least one address in the selected province.
  </div>

  <div class="row">
    <input id="addr" type="text" placeholder="Examples: '46011 Valencia' · 'Valencia' · 'Comunidad Valenciana' · '33010 Oviedo'"/>
    <button id="go">Search installers</button>
    <button id="darkbtn" title="Toggle dark mode">Dark mode</button>
  </div>

  <div id="formatted" class="preview small"></div>
  <div id="answer" class="answer small" style="display:none;"></div>

  <div class="grid" style="margin-top:16px;">
    <div>
      <div class="card">
        <div class="small">Sorted by <b>Rating</b> (desc). Only <b>Active</b> installers. One row per installer (best rating in that province).</div>
        <table id="res">
          <thead><tr><th>Installer</th><th>Province</th><th>Rating</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div><b>Map</b></div>
          <div class="small">Formatted address</div>
        </div>
        <!-- Discreet credit -->
        <div class="small" style="opacity:.7; margin:-2px 0 10px 0;">created by <b>Luis Daniel Mendoza luisme</b></div>
        <iframe id="gmaps" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:8px;">
    Data source: embedded table (INSTALLER · Address · RATE). If you prefer Google Sheets + Maps JS (precise marker), I can share that variant.
  </div>
</div>

<script>
/* ================== Minimal fallback (will be replaced by your TSV) ================== */
const DATA = [
  { Instalador:"Bainga", Zona:"Valencia", Activo:"Sí", Calificación:5 },
  { Instalador:"Insvert", Zona:"Alicante", Activo:"Sí", Calificación:5 },
  { Instalador:"Vettes Solar", Zona:"Madrid", Activo:"Sí", Calificación:5 },
];

/* ========== Address normalizer (ES) ========== */
const STREET_ABBR = [
  { rx:/^(cl|c\/|c\.|cl\.|calle)\b/i, full:"Calle" },
  { rx:/^(av|av\.|avda|avd|avenida)\b/i, full:"Avenida" },
  { rx:/^(ps|pso|p\.º|pº|paseo)\b/i, full:"Paseo" },
  { rx:/^(ctra|crta|carretera)\b/i, full:"Carretera" },
  { rx:/^(pl|pl\.|plaza)\b/i, full:"Plaza" },
  { rx:/^(cam|cno|camino)\b/i, full:"Camino" },
  { rx:/^(rda|ronda|rnd)\b/i, full:"Ronda" },
  { rx:/^(trv|trva|travesi?a)\b/i, full:"Travesía" },
  { rx:/^(pje|ptja|pasaje)\b/i, full:"Pasaje" },
  { rx:/^(urb|urbanizaci[oó]n)\b/i, full:"Urbanización" },
  { rx:/^(pgno|pol[íi]gono|poligono)\b/i, full:"Polígono" }
];
function titleCase(str){ return str.replace(/\S+/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase()); }
function normalizeStreet(raw){
  let s = String(raw||"").trim().replace(/\s+/g, " ");
  const firstLine = s.split(/[\n,]/)[0].trim();
  let out = firstLine;
  for (const rule of STREET_ABBR){ if (rule.rx.test(firstLine)){ out = firstLine.replace(rule.rx, rule.full); break; } }
  out = out.split(" ").map(tok=> (/^\d/.test(tok)? tok : titleCase(tok))).join(" ");
  return out;
}
function extractZip(text){ const m = String(text||"").match(/\b(\d{5})\b/); return m ? m[1] : ""; }
function extractLocality(text){
  const a = String(text||"");
  const cp = extractZip(a);
  if (cp){
    const idx = a.indexOf(cp);
    if (idx>=0){
      const tail = a.slice(idx + cp.length).replace(/[,|\n]/g," ").trim();
      return tail.split(/\s+/).slice(0,3).join(" ").trim();
    }
  }
  const parts = a.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
  return parts.length>1 ? parts[parts.length-1] : "";
}

/* ===== Provinces + Communities ===== */
function norm(s){ return String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }

const PROVINCES = [
  {name:"Álava", aliases:["Álava","Araba","Alava"]},
  {name:"Albacete", aliases:["Albacete"]},
  {name:"Alicante", aliases:["Alicante","Alacant"]},
  {name:"Almería", aliases:["Almería","Almeria"]},
  {name:"Ávila", aliases:["Ávila","Avila"]},
  {name:"Badajoz", aliases:["Badajoz"]},
  {name:"Illes Balears", aliases:["Illes Balears","Islas Baleares","Baleares","Mallorca","Menorca","Ibiza"]},
  {name:"Barcelona", aliases:["Barcelona"]},
  {name:"Burgos", aliases:["Burgos"]},
  {name:"Cáceres", aliases:["Cáceres","Caceres"]},
  {name:"Cádiz", aliases:["Cádiz","Cadiz"]},
  {name:"Castellón", aliases:["Castellón","Castello","Castelló"]},
  {name:"Ciudad Real", aliases:["Ciudad Real"]},
  {name:"Córdoba", aliases:["Córdoba","Cordoba"]},
  {name:"A Coruña", aliases:["A Coruña","La Coruña","Coruña","Coruna","A Coruna"]},
  {name:"Cuenca", aliases:["Cuenca"]},
  {name:"Girona", aliases:["Girona","Gerona"]},
  {name:"Granada", aliases:["Granada"]},
  {name:"Guadalajara", aliases:["Guadalajara"]},
  {name:"Gipuzkoa", aliases:["Gipuzkoa","Guipúzcoa","Guipuzcoa"]},
  {name:"Huelva", aliases:["Huelva"]},
  {name:"Huesca", aliases:["Huesca"]},
  {name:"Jaén", aliases:["Jaén","Jaen"]},
  {name:"León", aliases:["León","Leon"]},
  {name:"Lleida", aliases:["Lleida","Lérida","Lerida"]},
  {name:"La Rioja", aliases:["La Rioja","Rioja"]},
  {name:"Lugo", aliases:["Lugo"]},
  {name:"Madrid", aliases:["Madrid"]},
  {name:"Málaga", aliases:["Málaga","Malaga"]},
  {name:"Murcia", aliases:["Murcia"]},
  {name:"Navarra", aliases:["Navarra","Nafarroa"]},
  {name:"Ourense", aliases:["Ourense","Orense"]},
  {name:"Asturias", aliases:["Asturias","Oviedo","Gijón","Gijon","Avilés","Aviles"]},
  {name:"Palencia", aliases:["Palencia"]},
  {name:"Las Palmas", aliases:["Las Palmas"]},
  {name:"Pontevedra", aliases:["Pontevedra"]},
  {name:"Salamanca", aliases:["Salamanca"]},
  {name:"Segovia", aliases:["Segovia"]},
  {name:"Sevilla", aliases:["Sevilla"]},
  {name:"Soria", aliases:["Soria"]},
  {name:"Tarragona", aliases:["Tarragona"]},
  {name:"Santa Cruz de Tenerife", aliases:["Santa Cruz de Tenerife","Tenerife"]},
  {name:"Teruel", aliases:["Teruel"]},
  {name:"Toledo", aliases:["Toledo"]},
  {name:"Valencia", aliases:["Valencia","València"]},
  {name:"Valladolid", aliases:["Valladolid"]},
  {name:"Bizkaia", aliases:["Bizkaia","Vizcaya"]},
  {name:"Zamora", aliases:["Zamora"]},
  {name:"Zaragoza", aliases:["Zaragoza"]},
  {name:"Ceuta", aliases:["Ceuta"]},
  {name:"Melilla", aliases:["Melilla"]},
];

const CP_TO_PROV = {
  "01":"Álava","02":"Albacete","03":"Alicante","04":"Almería","05":"Ávila","06":"Badajoz","07":"Illes Balears","08":"Barcelona","09":"Burgos",
  "10":"Cáceres","11":"Cádiz","12":"Castellón","13":"Ciudad Real","14":"Córdoba","15":"A Coruña","16":"Cuenca","17":"Girona","18":"Granada",
  "19":"Guadalajara","20":"Gipuzkoa","21":"Huelva","22":"Huesca","23":"Jaén","24":"León","25":"Lleida","26":"La Rioja","27":"Lugo","28":"Madrid",
  "29":"Málaga","30":"Murcia","31":"Navarra","32":"Ourense","33":"Asturias","34":"Palencia","35":"Las Palmas","36":"Pontevedra","37":"Salamanca",
  "38":"Santa Cruz de Tenerife","39":"Cantabria","40":"Segovia","41":"Sevilla","42":"Soria","43":"Tarragona","44":"Teruel","45":"Toledo","46":"Valencia",
  "47":"Valladolid","48":"Bizkaia","49":"Zamora","50":"Zaragoza","51":"Ceuta","52":"Melilla"
};

/* Communities → provinces */
const COMMUNITY_TO_PROVINCES = {
  "andalucia": ["Almería","Cádiz","Córdoba","Granada","Huelva","Jaén","Málaga","Sevilla"],
  "aragon": ["Huesca","Teruel","Zaragoza"],
  "asturias": ["Asturias"],
  "baleares": ["Illes Balears"],
  "canarias": ["Las Palmas","Santa Cruz de Tenerife"],
  "cantabria": ["Cantabria"],
  "castilla y leon": ["Ávila","Burgos","León","Palencia","Salamanca","Segovia","Soria","Valladolid","Zamora"],
  "castilla-la mancha": ["Albacete","Ciudad Real","Cuenca","Guadalajara","Toledo"],
  "cataluna": ["Barcelona","Girona","Lleida","Tarragona"],
  "cataluña": ["Barcelona","Girona","Lleida","Tarragona"],
  "catalunya": ["Barcelona","Girona","Lleida","Tarragona"],
  "ceuta": ["Ceuta"],
  "extremadura": ["Badajoz","Cáceres"],
  "galicia": ["A Coruña","Lugo","Ourense","Pontevedra"],
  "la rioja": ["La Rioja"],
  "madrid": ["Madrid"],
  "murcia": ["Murcia"],
  "navarra": ["Navarra"],
  "pais vasco": ["Álava","Gipuzkoa","Bizkaia"],
  "paisvasco": ["Álava","Gipuzkoa","Bizkaia"],
  "euskadi": ["Álava","Gipuzkoa","Bizkaia"],
  "valenciana": ["Alicante","Castellón","Valencia"],
  "comunidad valenciana": ["Alicante","Castellón","Valencia"],
  "comunitat valenciana": ["Alicante","Castellón","Valencia"],
  "melilla": ["Melilla"]
};

function detectProvince(text){
  const s = norm(text);
  for (const p of PROVINCES){
    if (p.aliases.some(a => s.includes(norm(a)))) return p.name;
  }
  const cp = extractZip(text);
  if (cp && CP_TO_PROV[cp.slice(0,2)]) return CP_TO_PROV[cp.slice(0,2)];
  return "";
}
function detectCommunity(text){
  const s = norm(text);
  for (const k in COMMUNITY_TO_PROVINCES){
    if (s.includes(k)) return k;
  }
  if (s.includes("comunidad de madrid")) return "madrid";
  if (s.includes("comunidad valenciana") || s.includes("comunitat valenciana")) return "valenciana";
  return "";
}
function extractProvinceFromAddress(addr){ return detectProvince(addr); }

/* ================== Recommender ================== */
function toNum(x){ const n = parseFloat(String(x).replace(",", ".")); return isNaN(n) ? 0 : n; }
function activeOnly(rows){ return rows.filter(r => String(r.Activo||"").toLowerCase().match(/^(si|sí|true|yes)$/)); }
function sortByRating(rows){
  return rows.slice().sort((a,b)=>{
    const d = toNum(b.Calificación) - toNum(a.Calificación);
    if (Math.abs(d) > 1e-9) return d;
    return String(a.Instalador).localeCompare(String(b.Instalador));
  });
}
/* Keep one row per installer: best rating inside the selected province */
function bestPerInstaller(rows){
  const best = new Map();
  for (const r of rows){
    const key = r.Instalador;
    if (!best.has(key) || toNum(r.Calificación) > toNum(best.get(key).Calificación)){
      best.set(key, r);
    }
  }
  return Array.from(best.values());
}
function renderTable(rows){
  const tb = document.querySelector("#res tbody");
  tb.innerHTML = "";
  if(!rows.length){
    const tr=document.createElement("tr");
    const td=document.createElement("td");
    td.colSpan=3;
    td.textContent="No matches. Type a province (e.g., Valencia, Alicante, Madrid, Sevilla) or a community (Andalucía, Galicia…).";
    tr.appendChild(td); tb.appendChild(tr); return;
  }
  for(const r of rows){
    const tr=document.createElement("tr");
    const td1=document.createElement("td"); td1.textContent=r.Instalador;
    const td2=document.createElement("td"); td2.textContent=r.Provincia || "(unknown)";
    const td3=document.createElement("td"); td3.textContent=(r.Calificación ?? 0);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tb.appendChild(tr);
  }
}

/* ================== Search, explanation & map ================== */
function buildFormattedAddress(raw){
  const street = normalizeStreet(raw);
  const cp = extractZip(raw);
  const loc = extractLocality(raw);
  let line1 = street || "";
  let line2 = (cp ? cp+" " : "") + (loc || "");
  line2 = line2.trim();
  const formatted = [line1, line2].filter(Boolean).join("\n");
  return { formatted, line1, line2, cp, loc };
}
function updateMapFromFormatted(formatted){
  const iframe = document.getElementById("gmaps");
  const q = encodeURIComponent(String(formatted||"").replace(/\n/g, ", "));
  iframe.src = `https://www.google.com/maps?q=${q}&output=embed`;
}

function buildAnswerText(addrRaw, formatted, province, community, ordered){
  const box = document.getElementById("answer");
  const names = ordered.map(r=>r.Instalador);
  let msg = "";
  if (!addrRaw.trim()){
    msg = "No address provided. Showing active installers in general (type a province or community to filter).";
  } else if (province && ordered.length){
    msg = `Interpreted address:\n${formatted}\n\nDetected province: ${province}.\n\nInstallers with at least one address in this province (sorted by rating): ${names.join(", ")}.`;
  } else if (community && ordered.length){
    msg = `Interpreted address:\n${formatted}\n\nDetected autonomous community: ${community}.\n\nInstallers acting in its provinces (sorted by rating): ${names.join(", ")}.`;
  } else if (province || community){
    msg = `Interpreted address:\n${formatted}\n\nDetected ${province ? "province" : "community"}: ${province || community}.\n\nNo active installers found in the embedded table for that area.`;
  } else {
    msg = `Interpreted address:\n${formatted}\n\nCouldn't detect a province/community. Try “Valencia”, “Comunidad Valenciana”, “Madrid”… or add a postal code.`;
  }
  box.textContent = msg;
  box.style.display = "block";
}

/* Annotate province in each DATA row */
function annotateProvincesInData(){
  for (const r of DATA){ if (!r.Provincia) r.Provincia = extractProvinceFromAddress(r.Zona || ""); }
}

/* === Search by PROVINCE (preferred) or COMMUNITY (fallback) === */
function search(){
  const raw = document.getElementById("addr").value || "";
  const { formatted, line2 } = buildFormattedAddress(raw);
  document.getElementById("formatted").textContent = formatted || "—";

  const province = detectProvince(line2 || raw);
  const communityKey = detectCommunity(line2 || raw);

  let matches = activeOnly(DATA);
  if (province){
    matches = matches.filter(r => norm(r.Provincia) === norm(province));
  } else if (communityKey){
    const provs = COMMUNITY_TO_PROVINCES[communityKey] || [];
    matches = matches.filter(r => provs.some(p => norm(r.Provincia) === norm(p)));
  }

  /* Keep best rating per installer within the selected province/community, then sort by rating */
  const perInstaller = bestPerInstaller(matches);
  const ordered = sortByRating(perInstaller);

  renderTable(ordered);
  buildAnswerText(raw, formatted || raw, province, communityKey, ordered);
  updateMapFromFormatted(formatted || raw || "Spain");
}

/* Events */
document.getElementById("go").addEventListener("click", search);
/* Enter to search */
document.getElementById("addr").addEventListener("keydown", (ev)=>{ if (ev.key === "Enter"){ ev.preventDefault(); search(); }});

/* Dark mode */
function applyDark(on){
  document.body.classList.toggle("dark", !!on);
  localStorage.setItem("dark", on ? "1" : "0");
  document.getElementById("darkbtn").textContent = on ? "Light mode" : "Dark mode";
}
document.getElementById("darkbtn").addEventListener("click", ()=> applyDark(!document.body.classList.contains("dark")));
applyDark(localStorage.getItem("dark")==="1");

/* Initial state */
annotateProvincesInData();
document.getElementById("formatted").textContent = "—";
document.getElementById("answer").style.display = "none";
/* Show all active installers (best per installer) by default */
renderTable(sortByRating(bestPerInstaller(activeOnly(DATA))));
updateMapFromFormatted("Spain");
</script>

<!-- ======= PASTE HERE YOUR FULL TABLE (TSV with headers: INSTALLER \t Address \t RATE) ======= -->
<script type="text/plain" id="tsv-data">
<!-- Paste below the FULL table you sent (no quotes), columns: INSTALLER[TAB]Address[TAB]RATE -->
</script>

<!-- ===== TSV parser → replaces DATA with your table ===== -->
<script>
(function(){
  const tsvEl = document.getElementById('tsv-data');
  if (!tsvEl) return;
  const raw = (tsvEl.textContent || tsvEl.innerText || "").trim();
  if (!raw) return;

  function parseTSV(tsv){
    const lines = tsv.split(/\r?\n/).filter(l => l.trim().length);
    if (!lines.length) return [];
    const header = lines.shift().split('\t').map(h => h.trim().toLowerCase());
    const iInst = header.findIndex(h => /^installer/.test(h));
    const iAddr = header.findIndex(h => /^address/.test(h));
    const iRate = header.findIndex(h => /^rate/.test(h));
    const out = [];
    for (const line of lines){
      const cols = line.split('\t');
      const inst = (cols[iInst]||"").trim();
      const addr = (cols[iAddr]||"").trim();
      const rate = parseFloat(String(cols[iRate]||"0").replace(",", "."));
      if (inst && addr){
        out.push({
          Instalador: inst,
          Zona: addr,
          Activo: "Sí",
          Calificación: isNaN(rate) ? 0 : rate,
          Provincia: extractProvinceFromAddress(addr)
        });
      }
    }
    return out;
  }

  const rows = parseTSV(raw);
  if (Array.isArray(rows) && rows.length){
    DATA.length = 0;
    for (const r of rows) DATA.push(r);
    annotateProvincesInData();
    /* Refresh initial view with your data */
    renderTable(sortByRating(bestPerInstaller(activeOnly(DATA))));
    const current = document.getElementById("addr").value.trim();
    if (current){ search(); }
  }
})();
</script>
</body>
</html>
