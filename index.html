import React, { useMemo, useState, useEffect } from "react";

/** === DATA: Installers with regions + rating (replaces previous table) === */
const INSTALLERS = [
  { name: "BAINGA", regions: ["Comunitat Valenciana"], rating: 5 },
  {
    name: "BSSPAIN",
    regions: [
      "Andalucía",
      "Castilla-La Mancha",
      "Castilla y León",
      "Comunidad de Madrid",
      "Comunitat Valenciana",
      "Región de Murcia",
    ],
    rating: 2,
  },
  { name: "ECO AMPER SL", regions: ["Comunitat Valenciana", "Región de Murcia"], rating: 5 },
  { name: "Ecofutur", regions: ["Comunitat Valenciana"], rating: 3 },
  { name: "EEGA Suministros Energéticos", regions: ["Galicia"], rating: 4 },
  { name: "Era Renovables", regions: ["Andalucía", "Aragón"], rating: 5 },
  { name: "FUERZA&HONOR SL", regions: ["Illes Balears", "Andalucía"], rating: 4 },
  {
    name: "Grupo Ecosar",
    regions: ["Asturias","Cantabria","País Vasco","Galicia","Castilla y León","Comunidad de Madrid"],
    rating: 4,
  },
  {
    name: "GRUPO MQ LA MANCHA S.L.U",
    regions: ["Castilla-La Mancha","Comunidad de Madrid","Andalucía","Aragón"],
    rating: 1,
  },
  { name: "JOVITEL SL", regions: ["Andalucía"], rating: 4 },
  {
    name: "KAYLON ENERGIAS RENOVABLES S.L.",
    regions: [
      "Cataluña","Comunidad de Madrid","Castilla-La Mancha","Castilla y León",
      "Aragón","Navarra","País Vasco","Cantabria","Extremadura",
    ],
    rating: 4,
  },
  {
    name: "PROYECTOS ENERGÉTICOS INERGYA, S.L.",
    regions: ["Región de Murcia", "Comunitat Valenciana"],
    rating: 3,
  },
];

/** Utility to draw stars from rating 0-5 */
const Stars = ({ value = 0 }) => {
  const full = "★".repeat(value);
  const empty = "☆".repeat(5 - value);
  return <span aria-label={`${value} out of 5`}>{full}{empty}</span>;
};

/**
 * InstallerDirectoryOverlay
 * - English UI
 * - Dark mode toggle
 * - Search triggers on Enter
 * - Renders ABOVE the map by @luisme (use absolute overlay + high z-index)
 */
export default function InstallerDirectoryOverlay() {
  const [dark, setDark] = useState(false);
  const [query, setQuery] = useState("");
  const [committedQuery, setCommittedQuery] = useState("");

  // Optional: if your page already toggles a .dark class on <html>, keep this,
  // otherwise remove the effect and style locally with the `dark` state below.
  useEffect(() => {
    const root = document.documentElement;
    if (dark) root.classList.add("dark");
    else root.classList.remove("dark");
  }, [dark]);

  const filtered = useMemo(() => {
    const q = committedQuery.trim().toLowerCase();
    if (!q) return INSTALLERS;
    return INSTALLERS.filter((i) => {
      const inName = i.name.toLowerCase().includes(q);
      const inRegions = i.regions.join(", ").toLowerCase().includes(q);
      return inName || inRegions;
    });
  }, [committedQuery]);

  const handleSearch = () => setCommittedQuery(query);

  const handleKeyDown = (e) => {
    if (e.key === "Enter") {
      handleSearch(); // ← triggers search on Enter
    }
  };

  return (
    <div
      // Overlay ABOVE the existing map (created by Luis Daniel Mendoza @luisme)
      // If your map container has an id (e.g., #mapLuis), this overlay will sit on top.
      style={{
        position: "absolute",
        top: 16,
        left: 16,
        right: "auto",
        zIndex: 9999, // ensure it's above map controls
        maxWidth: 720,
        pointerEvents: "auto",
        fontFamily: "system-ui, Segoe UI, Roboto, Arial, sans-serif",
      }}
    >
      <div
        style={{
          background: dark ? "#0f172a" : "white",
          color: dark ? "#e2e8f0" : "#0f172a",
          border: `1px solid ${dark ? "#1f2937" : "#e5e7eb"}`,
          borderRadius: 16,
          boxShadow: dark
            ? "0 8px 24px rgba(0,0,0,0.6)"
            : "0 8px 24px rgba(0,0,0,0.12)",
          overflow: "hidden",
        }}
      >
        {/* Header */}
        <div
          style={{
            display: "flex",
            gap: 12,
            alignItems: "center",
            justifyContent: "space-between",
            padding: 16,
            borderBottom: `1px solid ${dark ? "#1f2937" : "#eef2f7"}`,
          }}
        >
          <div style={{ fontSize: 18, fontWeight: 700 }}>
            Solar Installers (Spain)
          </div>

          {/* Dark mode toggle */}
          <label
            style={{
              display: "inline-flex",
              alignItems: "center",
              gap: 8,
              cursor: "pointer",
              userSelect: "none",
            }}
            title="Toggle dark mode"
          >
            <span style={{ fontSize: 12, opacity: 0.8 }}>
              {dark ? "Dark" : "Light"} mode
            </span>
            <input
              type="checkbox"
              checked={dark}
              onChange={(e) => setDark(e.target.checked)}
              style={{ display: "none" }}
            />
            <span
              aria-hidden
              style={{
                width: 44,
                height: 24,
                borderRadius: 999,
                background: dark ? "#334155" : "#d1d5db",
                position: "relative",
                transition: "background 120ms ease",
                boxShadow: "inset 0 0 0 1px rgba(0,0,0,0.08)",
              }}
              onClick={() => setDark((v) => !v)}
            >
              <span
                style={{
                  position: "absolute",
                  top: 2,
                  left: dark ? 22 : 2,
                  width: 20,
                  height: 20,
                  borderRadius: "50%",
                  background: dark ? "#e5e7eb" : "white",
                  transition: "left 120ms ease",
                  boxShadow: "0 1px 2px rgba(0,0,0,0.25)",
                }}
              />
            </span>
          </label>
        </div>

        {/* Controls */}
        <div style={{ padding: 16, display: "flex", gap: 8 }}>
          <input
            type="text"
            placeholder="Search by installer or region…"
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            onKeyDown={handleKeyDown} // ← Enter triggers search
            style={{
              flex: 1,
              height: 40,
              padding: "0 12px",
              borderRadius: 10,
              border: `1px solid ${dark ? "#334155" : "#e5e7eb"}`,
              background: dark ? "#111827" : "white",
              color: dark ? "#e5e7eb" : "#111827",
              outline: "none",
            }}
          />
          <button
            onClick={handleSearch}
            style={{
              height: 40,
              padding: "0 14px",
              borderRadius: 10,
              border: "none",
              cursor: "pointer",
              background: "#2563eb",
              color: "white",
              fontWeight: 600,
            }}
          >
            Search
          </button>
        </div>

        {/* Table */}
        <div style={{ maxHeight: 420, overflow: "auto" }}>
          <table
            style={{
              width: "100%",
              borderCollapse: "separate",
              borderSpacing: 0,
              fontSize: 14,
            }}
          >
            <thead
              style={{
                position: "sticky",
                top: 0,
                background: dark ? "#0f172a" : "#f8fafc",
                color: dark ? "#e5e7eb" : "#0f172a",
                zIndex: 1,
              }}
            >
              <tr>
                <th style={thStyle(dark)}>Installer</th>
                <th style={thStyle(dark)}>Regions</th>
                <th style={thStyle(dark)}>Rating</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((i, idx) => (
                <tr key={`${i.name}-${idx}`} style={{ borderTop: `1px solid ${dark ? "#1f2937" : "#eef2f7"}`}}>
                  <td style={tdStyle(dark)}>{i.name}</td>
                  <td style={tdStyle(dark)}>{i.regions.join(", ")}</td>
                  <td style={{ ...tdStyle(dark), whiteSpace: "nowrap" }}>
                    <Stars value={i.rating} />
                  </td>
                </tr>
              ))}
              {filtered.length === 0 && (
                <tr>
                  <td colSpan={3} style={{ ...tdStyle(dark), textAlign: "center", opacity: 0.7 }}>
                    No results found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {/* Footer */}
        <div
          style={{
            padding: 12,
            fontSize: 12,
            opacity: 0.7,
            textAlign: "right",
            borderTop: `1px solid ${dark ? "#1f2937" : "#eef2f7"}`,
          }}
        >
          Data: curated list • Overlay above map by Luis Daniel Mendoza (@luisme)
        </div>
      </div>
    </div>
  );
}

/** Small helpers for table styles */
function thStyle(dark) {
  return {
    textAlign: "left",
    padding: "10px 14px",
    fontWeight: 700,
    fontSize: 12,
    textTransform: "uppercase",
    letterSpacing: 0.4,
    borderBottom: `1px solid ${dark ? "#1f2937" : "#eef2f7"}`,
  };
}
function tdStyle(dark) {
  return {
    padding: "12px 14px",
    verticalAlign: "top",
    color: dark ? "#e5e7eb" : "#111827",
  };
}
